{extend name="../user-layout" /}
{block name="content"}
<!--<link rel="stylesheet" href="__STATIC__/usercenter/css/bootstrap-select.css">-->
<style>
    .merchant-body {
        padding: 12px;
        border: 1px solid #BABABA;
        border-radius: 5px;
    }

    .users-avatar {
        float: left;
        width: 100px;
        height: 100px;
    }

    .users-info .users-detail {
        margin-left: 115px;
        letter-spacing: 1px;
        color: #ACAFB3;
    }

</style>

<style>

    .home-custom-search {
        position: relative;
        float: left;
        margin-bottom: 15px;
    }

    .home-custom-search .search-query {
        margin: 0;
        padding: 6px 10px;
        font-style: italic;
        background: #FFFFFF;
        border: 1px solid #e0e0e0;
        width: 200px;
        -webkit-transition: all 0.7s ease;
        -moz-transition: all 0.7s ease;
        -ms-transition: all 0.7s ease;
        -o-transition: all 0.7s ease;
        transition: all 0.7s ease;
        line-height: 20px;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        border-radius: 4px;
    }

    .home-custom-search i {
        padding: 0 0 0 10px;
        cursor: pointer;
        position: absolute;
        top: 9px;
        right: 12px;
        font-size: 16px;
    }

    .home-custom-search .search-query:focus {
        outline: none;
        border: 0;
        width: 260px;
        border: none;
        background: #ffffff;
        -webkit-border-radius: 50px;
        -moz-border-radius: 50px;
        border-radius: 50px;
        border: 1px solid #cccccc;
    }

    .btn-group .search-button {
        margin-right: 15px;
        background: #F9F9F9;
        border: transparent;
        border-radius: 4px;
        font-weight: bold;
    }


    .btn-group .active {
        color: #ffffff;
        background: #4286F7;
    }


    .screen .screen-body {
        margin-bottom: 25px;
    }

    .screen span {
        background-color: #F6F7F8;
        color: #61666D;
        padding: 6px 10px;
        border-radius: 6px;
        margin-right: 8px;
        cursor: pointer;
    }

    .screen .active {
        background: #4286F7;
        color: #ffffff;
    }

</style>

<style>
    /*  Border Radius  */
    .users-wrapper {
        padding: 0;
        position: relative;
        border-radius: 0;
        margin-bottom: 10px;
        background: #fcfcfc;
        -webkit-border-radius: 2px;
        -moz-border-radius: 2px;
        border-radius: 2px;
        -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2), 0 1px 1px rgba(0, 0, 0, 0.1);
        box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2), 0 1px 1px rgba(0, 0, 0, 0.1);
    }

    .users-wrapper.green {
        border-top: 2px solid #32AB52;
    }

    .users-wrapper.yellow {
        border-top: 2px solid #F9BB06;
    }

    .users-wrapper.red {
        border-top: 2px solid #E84234;
    }

    .users-wrapper.blue {
        border-top: 2px solid #4286F7;
    }

    .users-wrapper .users-info {
        padding: 15px;
    }

    .users-wrapper .users-info .users-avatar {
        width: 60px;
        height: 60px;
        float: left;
    }

    .users-wrapper .users-info .users-avatar img {
        -webkit-border-radius: 2px;
        -moz-border-radius: 2px;
        border-radius: 2px;
    }

    .users-wrapper .users-info .users-detail {
        margin-left: 75px;
    }

    .users-wrapper .users-info .users-detail h5 {
        padding: 0;
        margin: 12px 0 2px 0;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    .users-wrapper .users-info .users-detail p {
        margin: 0;
        padding: 0;
        font-size: 11px;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    .users-wrapper ul.users-footer {
        background: #f0f0f0;
    }

    .users-wrapper ul.users-footer li {
        float: left;
        width: 40%;
        padding: 10px 10px 10px 15px;
        box-sizing: border-box;
        border-left: 1px solid #e0e0e0;
    }

    .users-wrapper ul.users-footer li:first-child {
        border-left: 0;
    }

    .users-wrapper ul.users-footer li:last-child {
        width: 20%;
        border-left: 0;
    }

    .users-wrapper ul.users-footer li p {
        margin: 0;
        padding: 0;
        line-height: 100%;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    .users-wrapper ul.users-footer li p.light {
        margin: 0 0 5px 0;
        font-size: 11px;
        font-style: italic;
    }

    .users-wrapper ul.users-footer li .add-btn {
        -webkit-transition: all 0.3s ease-in-out;
        -moz-transition: all 0.3s ease-in-out;
        -ms-transition: all 0.3s ease-in-out;
        -o-transition: all 0.3s ease-in-out;
        transition: all 0.3s ease-in-out;
        float: right;
        -webkit-border-radius: 30px;
        -moz-border-radius: 30px;
        border-radius: 30px;
        background: #FFFFFF;
        width: 30px;
        height: 30px;
        text-align: center;
        display: block;
    }

    .users-wrapper ul.users-footer li .add-btn i {
        -webkit-transition: all 0.3s ease-in-out;
        -moz-transition: all 0.3s ease-in-out;
        -ms-transition: all 0.3s ease-in-out;
        -o-transition: all 0.3s ease-in-out;
        transition: all 0.3s ease-in-out;
        color: #32AB52;
        font-size: 20px;
        line-height: 30px;
    }

    .users-wrapper ul.users-footer li .add-btn.added {
        background: #32AB52;
    }

    .users-wrapper ul.users-footer li .add-btn.added i {
        color: #ffffff;
    }

    .card-wrapper {
        margin-bottom: 10px;
        background: #fcfcfc;
        -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.1), 0 1px 1px rgba(0, 0, 0, 0.1);
        box-shadow: 0 1px 0px rgba(0, 0, 0, 0.1), 0 1px 1px rgba(0, 0, 0, 0.1);
        border-top: 2px solid #F9BB06;
        -webkit-transition: all 1s ease-in-out;
        -moz-transition: all 1s ease-in-out;
        -ms-transition: all 1s ease-in-out;
        -o-transition: all 1s ease-in-out;
        transition: all 1s ease-in-out;
    }

    .card-wrapper .card {
        padding: 10px;
        text-align: center;
        position: relative;
        width: 100%;
        box-sizing: border-box;
    }

    .card-wrapper .card .card-type {
        position: absolute;
        right: 15px;
        top: 0;
        background-color: #f2f2f2;
        padding: 5px;
        width: 36px;
    }

    .card-wrapper .card .card-type:after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 0;
        border-top: 8px solid #f2f2f2;
        border-right: 16px solid transparent;
    }

    .card-wrapper .card .card-type:before {
        content: "";
        position: absolute;
        bottom: -8px;
        right: 0;
        border-top: 8px solid #f2f2f2;
        border-left: 16px solid transparent;
    }

    .card-wrapper .card img.card-avatar {
        width: 64px;
        height: 64px;
        margin: 30px auto;
        border: 2px solid #F9BB06;
        -webkit-border-radius: 2px;
        -moz-border-radius: 2px;
        border-radius: 2px;
    }

    .card-wrapper .card h5 {
        text-transform: uppercase;
        font-size: 13px;
        margin: 0 0 10px 0;
        font-weight: 500;
    }

    .card-wrapper .card p {
        font-size: 14px;
        margin: 0 0 10px 0;
    }

    .card-wrapper ul.card-actions {
        text-align: center;
    }

    .card-wrapper ul.card-actions li {
        width: 40px;
        margin: 0 5px 20px 5px;
        display: inline-block;
    }

    .card-wrapper ul.card-actions li .action-btn {
        display: block;
        width: 40px;
        height: 40px;
        line-height: 38px;
        background: #FFFFFF;
        -webkit-border-radius: 2px;
        -moz-border-radius: 2px;
        border-radius: 2px;
        border: 1px solid #ededed;
        z-index: 1;
        text-align: center;
    }

    .card-wrapper ul.card-actions li .action-btn i {
        display: block;
        font-size: 24px;
        line-height: 38px;
        color: #666666;
    }

    .card-wrapper ul.card-actions li .action-btn:hover {
        border: 1px solid #cccccc;
        box-shadow: 0 0 10px #b3b3b3;
    }

    .card-wrapper.red {
        border-top: 2px solid #E84234;
    }

    .card-wrapper.red img.card-avatar {
        border: 2px solid #E84234;
    }

    .card-wrapper.pink {
        border-top: 2px solid #F782AA;
    }

    .card-wrapper.pink img.card-avatar {
        border: 2px solid #F782AA;
    }

    .card-wrapper.blue {
        border-top: 2px solid #4286F7;
    }

    .card-wrapper.blue img.card-avatar {
        border: 2px solid #4286F7;
    }

    .card-wrapper.green {
        border-top: 2px solid #32AB52;
    }

    .card-wrapper.green img.card-avatar {
        border: 2px solid #32AB52;
    }

    .card-wrapper.violet {
        border-top: 2px solid #597FC5;
    }

    .card-wrapper.violet img.card-avatar {
        border: 2px solid #597FC5;
    }

    .card-wrapper.orange {
        border-top: 2px solid #FF9251;
    }

    .card-wrapper.orange img.card-avatar {
        border: 2px solid #FF9251;
    }

    .card-wrapper.peach {
        border-top: 2px solid #FF9997;
    }

    .card-wrapper.peach img.card-avatar {
        border: 2px solid #FF9997;
    }

    .card-wrapper.purple {
        border-top: 2px solid #C790E1;
    }

    .card-wrapper.purple img.card-avatar {
        border: 2px solid #C790E1;
    }

    .card-wrapper.brown {
        border-top: 2px solid #987345;
    }

    .card-wrapper.brown img.card-avatar {
        border: 2px solid #987345;
    }

    /*# sourceMappingURL=users.css.map */

</style>


<div class="container-fluid">
    <div class="row">
        <div class="panel">
            <div class="panel-body">
                <form class="form-inline" id="form1" action="/usercenter/index/index/index.html" method="get"
                      role="form">
                    <div class="home-custom-search">
                        <input type="text" name="username" value="{:input('username', '')}" class="search-query"
                               placeholder="请输入用户名称">
                        <i class="icon-search3" onclick="submit()"></i>
                    </div>
                    <div style="clear: both">

                        <div class="screen">
                            <div class="screen-body">
                                <strong style="font-weight: bold;margin-right: 25px">创建时间 <i class="icon-chevron-right" style="font-size: 1.2rem"></i>
                                </strong>
                                {if condition="$createTime == '' "}
                                <span class='active' data-field="createTime" data-value="">全部</span>
                                {else/}
                                <span data-field="createTime" data-value="">全部</span>
                                {/if}
                                {if condition="$createTime == 'w' "}
                                <span data-field="createTime" class='active' data-value="w">一周</span>
                                {else/}
                                <span data-field="createTime" data-value="w">一周</span>
                                {/if}
                                {if condition="$createTime == 'm' "}
                                <span data-field="createTime" class='active' data-value="m">一月</span>
                                {else/}
                                <span data-field="createTime" data-value="m">一月</span>
                                {/if}
                                {if condition="$createTime == '3m' "}
                                <span data-field="createTime" class='active' data-value="3m">三月</span>
                                {else/}
                                <span data-field="createTime" data-value="3m">三月</span>
                                {/if}
                                {if condition="$createTime == 'y' "}
                                <span data-field="createTime" class='active' data-value="y">一年</span>
                                {else/}
                                <span data-field="createTime" data-value="y">一年</span>
                                {/if}

                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="createTime" name="createTime" value="{$createTime}">

                </form>

            </div>

        </div>
        <div>
            <div class="row">

                {if condition="$user_info['user_type'] eq 1"}
                    {volist name="$lists" id="vo"}
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="card-wrapper ">
                            <div class="card clearfix detail-content" style="color: #ACAFB3">
                                <span class="card-type"></span>
                                <img src="{$vo.avatar}" class="img-responsive card-avatar" alt="{$vo.username}" >

                                <h4 style="font-weight: bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{$vo.username}">{$vo.username}</h4>
                                <p class="detail-content">{$vo.create_time}</p>

                                <table class="table" style="width: 100%;border: none">
                                    <tr>
                                        <td>所属支付中心用户：</td>
                                        <td>{$vo.merchant_username}</td>
                                    </tr>
                                </table>

                            </div>
                        </div>
                    </div>
                    {/volist}
                {elseif condition="$user_info['user_type'] eq 2"}
                    {volist name="$lists" id="vo"}
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                        <div class="card-wrapper ">
                            <div class="card clearfix detail-content" style="color: #ACAFB3">
                                <span class="card-type"></span>
                                <img src="{$vo.avatar}" class="img-responsive card-avatar" alt="{$vo.name}" >

                                <h4 style="font-weight: bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="{$vo.name}">{$vo.name}</h4>
                                <p class="detail-content">{$vo.create_time}</p>

                                <table class="table" style="width: 100%;border: none">
                                    <tr>
                                        <td>所属用户</td>
                                        <td>{$vo.username}</td>
                                    </tr>
                                </table>

                                {if condition="$user_info['user_type'] eq 2"}
                                <div class="input-group-text">
                                    {if condition="$vo.guarantee_id"}
                                    <button type="button" class="btn btn-sm btn-info guarantee-invite disabled"> <i class="icon-circle-with-minus"></i>邀请担保</button>
                                    {else/}
                                    <button type="button" class="btn btn-sm btn-info guarantee-invite" onclick="guaranteeInvite('{$vo.pay_center_uid}', '{$vo.id}')"> <i class="icon-log-out"></i>邀请担保</button>
                                    {/if}
                                    <button type="button" class="btn btn-sm btn-info guarantee-invite" onclick="bindChannel('{$vo.id}')"> <i class="icon-add-user"></i>渠道绑定</button>
                                </div>
                                {/if}
                            </div>
                        </div>
                    </div>
                    {/volist}
                {else/}
                {/if}
            </div>
            <div class="page-body-wrapper text-center">
                <nav aria-label="Page navigation">
                    {$lists->render()}
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="guaranteeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content"  data-backdrop="red">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">邀请担保</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="add-guarantee-form">
                    <input type="text" name="channel_user_id" hidden value="">
                    <input type="text" name="channel_id" hidden value="">
                    <div class="form-group">
                        <div class="col-sm-12 col-md-12">
                            <input type="number" class="form-control" required  id="amount" name="amount" value="" placeholder="请输入担保金额">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-info">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="bindChannel" tabindex="-1"  role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content"  data-backdrop="red">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">绑定渠道</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="add-bind-channel">
                    <input type="text" name="channel_id" id="bindChannelId" hidden value="">
                    <div class="form-group">
                        <div class="col-sm-12 col-md-12">
                            <select name="uid"  class="selectpicker form-control" id="bindChannelUid">


                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-info">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="__STATIC__/index/baisha/js/jquery.validate.min.js" type="text/javascript"></script>
<script type="text/javascript">

    $(function (){
        $("#add-guarantee-form").validate({
            errorElement: 'span',
            errorClass: 'help-block',
            rules: {
                amount: {
                    required: true,
                }
            },
            messages: {
                amount: {
                    required: "<span style='padding: 15px'>金额不能为空！</span>",
                }
            },
            focusInvalid: true,
            errorPlacement: function (error, element) {
                if(element.parent().hasClass("input-group"))
                    element.parent().next().remove();
                else
                    element.next().remove();
                //element.after('<span class="glyphicon glyphicon-remove form-control-feedback" aria-hidden="true"></span>');
                element.closest('.form-group').append(error);
                //element.after(error);
            },
            highlight: function (element) {
                $(element).closest('.form-group').addClass('has-error has-feedback');
            },
            success: function (label) {
                var el = label.closest('.form-group').find("input");
                if (el.parent().hasClass("input-group"))
                    el.parent().next().remove();
                else
                    el.next().remove();
                //el.after('<span class="glyphicon glyphicon-ok form-control-feedback" aria-hidden="true"></span>');
                label.closest('.form-group').removeClass('has-error').addClass("has-feedback has-success");
                label.remove();
            },
            submitHandler: function (form) {
                DoPost();
            }
        })

        $("#add-bind-channel").validate({
            errorElement: 'span',
            errorClass: 'help-block',
            rules: {
                channel_id: {
                    required: true,
                },
                uid: {
                    required: true,
                }
            },
            messages: {
                channel_id: {
                    required: "<span style='padding: 15px'>渠道标识不能为空！</span>",
                },
                uid: {
                    required: "<span style='padding: 15px'>商户不能为空！</span>",
                }
            },
            focusInvalid: true,
            errorPlacement: function (error, element) {
                if(element.parent().hasClass("input-group"))
                    element.parent().next().remove();
                else
                    element.next().remove();
                //element.after('<span class="glyphicon glyphicon-remove form-control-feedback" aria-hidden="true"></span>');
                element.closest('.form-group').append(error);
                //element.after(error);
            },
            highlight: function (element) {
                $(element).closest('.form-group').addClass('has-error has-feedback');
            },
            success: function (label) {
                var el = label.closest('.form-group').find("input");
                if (el.parent().hasClass("input-group"))
                    el.parent().next().remove();
                else
                    el.next().remove();
                //el.after('<span class="glyphicon glyphicon-ok form-control-feedback" aria-hidden="true"></span>');
                label.closest('.form-group').removeClass('has-error').addClass("has-feedback has-success");
                label.remove();
            },
            submitHandler: function (form) {
                bindChannelSubmit();
            }
        })
    })

    var guaranteeInvite = function (channel_user_id, id){
        $('#guaranteeModal').modal({
            keyword:false
        });
        $('[name="channel_user_id"]').val(channel_user_id);
        $('[name="channel_id"]').val(id);
    }

    var bindChannel = function (channel_id) {

        $.ajax({
            url: "{:url('/usercenter/merchants/getBindChannelUserList')}",
            type: "POST",
            data: {channel_id:channel_id},
            success: function (data) {
                code = data.code;
                message = data.msg;
                users = data.data;
            },
            error: function () {
                message = "提交失败";
            },
            complete: function () {
                if (code == 1) {
                    $('#bindChannelId').val(channel_id);
                    $('#bindChannelUid').children().remove();
                    $('#bindChannelUid').append($('<option value="">请选择商户</option>'));
                    for (var i=0; i<users.length;i++){
                        $('#bindChannelUid').append($('<option value='+ users[i].uid +'>'+ users[i].username +'</option>'))
                    }
                    $('#bindChannel').modal('toggle');
                }
                else {
                    swal({ title: "错误", text: message, icon: "error" });
                }
            }
        });
    }

    var DoPost = function () {
        var code = "", message = "";

        $.ajax({
            url: "{:url('/usercenter/guarantee_orders/addOrder')}",
            type: "POST",
            data: $("#add-guarantee-form").serialize(),
            success: function (data) {
                code = data.code;
                message = data.msg;

            },
            error: function () {
                message = "提交失败";
            },
            complete: function () {
                if (code == "1") {
                    $('#guaranteeModal').modal('toggle')
                    swal({ title: "邀请担保订单生成成功，已发送渠道，等待付款", text: "正在跳转...", icon: "success", button: false, timer: 3000 }).then(function (isConfirm) {
                        window.location.href = '/usercenter/index/index';
                    });
                }
                else {
                    swal({ title: "错误", text: message, icon: "error" });
                }
            }
        });
    };

    var submit = function () {
        let form1 = document.getElementById('form1');
        $(form1).submit()
    }

    var  bindChannelSubmit = function () {
        var code = "", message = "";
        $.ajax({
            url: "{:url('/usercenter/merchants/bindChannel')}",
            type: "POST",
            data: $("#add-bind-channel").serialize(),
            success: function (data) {
                code = data.code;
                message = data.msg;
            },
            error: function () {
                message = "提交失败";
            },
            complete: function () {
                if (code == "1") {
                    $('#bindChannel').modal('toggle')
                    swal({ title: "申请成功，等待渠道审核", text: "正在跳转...", icon: "success", button: false, timer: 3000 }).then(function (isConfirm) {
                        window.location.href = '/usercenter/bind_channel/index';
                    });
                }
                else {
                    swal({ title: "错误", text: message, icon: "error" });
                }
            }
        });
    }

    $('.screen-body span').on('click', function () {

        $.each($(this).siblings(), function (index, elem) {
            $(elem).removeClass('active')
        })
        let optionField = $(this).attr('data-field');
        let optionVal = $(this).attr('data-value');
        let input = document.getElementById(optionField);
        input.value = optionVal
        submit();

    })
</script>


{/block}


